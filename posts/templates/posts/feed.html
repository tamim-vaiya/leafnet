{% extends "users/base.html" %}
{% load static %}
{% load mathfilters %}

{% block body %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <h2 class="text-4xl font-semibold text-gray-800 mb-10 text-center">All Posts</h2>

  {% if posts %}
    <div class="grid grid-cols-1 gap-10">
      {% for post in posts %}
        <div class="rounded-xl shadow bg-white hover:shadow-lg transition-shadow duration-300 overflow-hidden">
          
          <!-- User Info -->
          <div class="flex items-center px-5 py-4 gap-4 border-b border-gray-200">
            <img class="w-12 h-12 rounded-full border border-gray-300 object-cover" src="{{ post.user.profile.photo.url }}" alt="{{ post.user }}">
            <div>
              <p class="text-gray-900 font-semibold text-base">{{ post.user }}</p>
              <p class="text-gray-500 text-xs">{{ post.created|date:"F d, Y" }}</p>
            </div>
          </div>

          <!-- Post Image -->
          <div class="w-full h-[450px] overflow-hidden">
            <img src="{{ post.image.url }}" alt="Post Image" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300 ease-in-out">
          </div>

          <!-- Social Icons -->
          <div class="px-5 py-3">
            <div class="flex items-center gap-4">
              <a id={{ post.id }} class ="btn-like">
                {% if logged_user in post.liked_by.all %}
                    <img class="w-6 h-6" src="{% static 'users/images/redheart.png' %}" alt="Like">
                {% else %}
                    <img class="w-6 h-6" src="{% static 'users/images/heart.png' %}" alt="Like">
                {% endif %}
              </a>
              <button class="hover:scale-110 transition-transform duration-200">
                <img class="w-6 h-6" src="{% static 'users/images/comment.png' %}" alt="Comment">
              </button>
              <button class="hover:scale-110 transition-transform duration-200">
                <img class="w-6 h-6" src="{% static 'users/images/share.png' %}" alt="Share">
              </button>
            </div>
          </div>

          <!-- Likes Counter -->
          <div class='ml-4 px-2'>
            {% if post.liked_by.count < 1 %}
            {% elif post.liked_by.count == 1 %}
                <p class='text-gray-500'>{{ post.liked_by.first }} likes it.</p>
            {% elif post.liked_by.count > 1 %}
                <p class='text-gray-500'>{{ post.liked_by.first }} and {{ post.liked_by.count|sub:1 }} others like it</p> <!-- I can do this too: {{ post.liked_by.count|add:"-1" }}  --> 
            {% endif %}
          </div>

          <!-- Post Content -->
          <div class="px-5 pb-2 pt-1 border-t border-gray-200">
              <p class="text-gray-800 font-bold text-lg">{{ post.title }}</p>
            {% if post.caption %}
              <p class="text-gray-700 pb-3 text-base leading-snug mt-1">{{ post.caption }}</p>
            {% endif %}
          </div>
          <!-- Comments Section -->
            <div class="px-6 py-4 space-y-4">
                <h4 class="font-semibold text-lg text-gray-800 mb-2">Comments</h4>
                {% if post.comments.all %}
                    {% for comment in post.comments.all %}
                    <div class="bg-gray-100 rounded-md px-4 py-2">
                        <p class="text-sm text-gray-700">
                        <span class="font-semibold text-gray-900">{{ comment.posted_by }}</span>:
                        {{ comment.body }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">{{ comment.created|date:"M d, Y H:i" }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500 italic">No comments yet. Be the first to share your thoughts.</p>
                {% endif %}
            </div>
         
            <!-- Comment Form -->
            <div class="px-6 pb-6">
                <form method="POST" class="bg-gray-50 border border-gray-200 rounded-md px-4 py-4 shadow-sm">
                    {% csrf_token %}
                    <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Add a Comment</label>
                    <textarea name="body" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 resize-none text-sm text-gray-800" placeholder="Write something...">{{ comment_form.body.value|default_if_none:"" }}</textarea>
                    </div>
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <input type="hidden" name="posted_by" value="{{ logged_user }}">
                    <div class="flex justify-end">
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-medium px-4 py-2 rounded-md shadow-sm transition duration-150">Post Comment</button>
                    </div>
                </form>
            </div>


          
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center text-gray-500 text-lg italic mt-16">No posts yet. Start sharing your moments!</p>
  {% endif %}
</div>
<script type="text/javascript">
    window.CSRF_TOKEN = "{{csrf_token}}";
    $(document).on('click', '.btn-like', function() {
        var post_id = this.id;
        $.ajax({
            method: "POST",
            url: "/posts/like/",
            data : {post_id:post_id},
            headers: {
                "X-CSRFToken": window.CSRF_TOKEN
            },
            success: function(response) {
                // window.location.href = "http://localhost:8000/posts/feed/";
                window.location.reload();
            },
        });
    });
</script>
{% endblock body %}